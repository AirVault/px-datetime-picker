<link rel="import" href="css/px-datetime-picker-styles.html"/>
<link rel="import" href="../px-datetime-field/px-datetime-field.html"/>
<link rel="import" href="../px-calendar-picker/px-calendar-picker.html"/>
<link rel="import" href="../px-datetime-common/px-datetime-behavior.html"/>
<link rel="import" href="../px-datetime-common/px-datetime-buttons.html"/>
<link rel="import" href="../px-datetime-common/px-datetime-button-behavior.html"/>
<link rel="import" href="../app-localize-behavior/app-localize-behavior.html" />
<link rel="import" href="../iron-dropdown/iron-dropdown.html">

<!--
The datetime components rely on <a href="https://momentjs.com/" target="_blank">Moment.js</a> and <a href="https://momentjs.com/timezone/" target="_blank">Moment Timezone</a>.

#### Usage

    <px-datetime-picker></px-datetime-picker>


#### Styling
The following custom properties are available for styling. Please also refer to px-forms-design and px-buttons-design for additional style variables used by this component.

Custom property | Description
:----------------|:-------------
`--px-datetime-picker-background-color` | Background color for the panel
`--px-datetime-picker-border-color` | Border color for the panel
`--px-datetime-picker-z-index` | The z-index of the container

@element px-datetime-picker
@blurb Element allowing to pick a date using a calendar or by typing it
@homepage index.html
@demo index.html
-->
<dom-module id="px-datetime-picker">
  <template>
    <style include="px-datetime-picker-styles"></style>

    <px-datetime-field
      id="field"
      slot="dropdown-trigger"
      time-zone="{{timeZone}}"
      moment-obj="{{_tempMomentObj}}"
      hide-time="{{hideTime}}"
      show-time-zone="{{showTimeZone}}"
      date-format="{{dateFormat}}"
      time-format="{{timeFormat}}"
      is-selected="[[opened]]"
      prevent-notification-on-change
      block-future-dates="{{blockFutureDates}}"
      block-past-dates="{{blockPastDates}}"
      resources="[[resources]]"
      language="[[language]]"
      formats="[[formats]]"
      date-min="[[minDate]]"
      date-max="[[maxDate]]">
    </px-datetime-field>
    <iron-dropdown
      id="dropdown"
      class="dt-iron-dropdown"
      opened="{{opened}}"
      vertical-align="top"
      horizontal-align="left"
      no-overlap="[[!fillContainer]]"
      dynamic-align="[[!fillContainer]]"
      vertical-offset="[[_getVerticalOffset(fillContainer)]]"
      position-target="[[_getPositionTarget(fillContainer, fitIntoElement)]]"
      fit-into="[[fitIntoElement]]">
      <div slot="dropdown-content" class="dt-container__box shadow-temporary">
        <div class="dt-p-calendar">
          <px-calendar-picker
            id="calendar"
            block-future-dates="{{blockFutureDates}}"
            block-past-dates="{{blockPastDates}}"
            prevent-range-selection
            from-moment="{{_tempMomentObj}}"
            base-date="[[_tempMomentObj]]"
            time-zone="[[timeZone]]"
            day-week-start-index="[[dayWeekStartIndex]]"
            resources="[[resources]]"
            language="[[language]]"
            formats="[[formats]]"
            min-date="[[minDate]]"
            max-date="[[maxDate]]">
          </px-calendar-picker>
          <button class="actionable caps dt-p-today" on-tap="_todayClicked">[[localize('Today')]]</button>
        </div>
        <div class="dt-p-time-buttons--wrapper">
          <template id="timeTemplate" is="dom-if" if="{{_handleField(hideTime, fillContainer)}}">
            <div>
              <px-datetime-field
                id="time"
                class="dt-p-time"
                moment-obj="{{_tempMomentObj}}"
                hide-icon
                hide-date
                is-valid="{{_toTimeIsValid}}"
                time-format="{{timeFormat}}"
                time-zone="[[timeZone]]"
                resources="[[resources]]"
                language="[[language]]"
                formats="[[formats]]"
                min-date="[[minDate]]"
                max-date="[[maxDate]]">
              </px-datetime-field>
            </div>
          </template>
          <template is="dom-if" if="{{showButtons}}">
            <px-datetime-buttons
              class="dt-p-buttons"
              is-submit-button-valid
              resources="[[resources]]"
              language="[[language]]"
              formats="[[formats]]">
            </px-datetime-buttons>
          </template>
        </div>
      </div>
    </iron-dropdown>
  </template>
</dom-module>

<script>
  Polymer({

    is: 'px-datetime-picker',
    behaviors:[
      pxDatetimeTempMomentBehavior,
      pxDatetimeButtonBehavior,
      Polymer.AppLocalizeBehavior
    ],

    /**
     * Properties block, expose attribute values to the DOM via 'notify'
     *
     * @property properties
     * @type Object
     */
    properties: {
      /**
       *
       * Can be set to show the timezone in the field. Can have 2 values:
       *  'dropdown': shows the time zone as a dropdown which the user can use to
       * select a different time zone. Only contains a subset of all timezones
       *  'extendedDropdown': shows the time zone as a dropdown which the user can use to
       * select a different time zone. Contains all existing timezones (588)
       *  'text': shows the time zone as text, non editable
       *  'abbreviatedText': shows the time zone as an abbreviated text, non editable (such as PST, EST...)
       */
      showTimeZone: {
        type: String,
        value: ''
      },
      /**
       * Whether this date picker should allow to pick time as well.
       *
       */
      hideTime: {
        type: Boolean,
        value: false
      },
      /**
       * Moment format used for the date
       *
       */
      dateFormat: {
        type: String,
        value: 'MM/DD/YYYY'
      },
      /**
       * Moment format used for the time
       *
       */
       timeFormat: {
        type: String,
        value: 'HH:mm A'
      },
      /**
       * Reflects if datetime-picker container is open/visible.
       */
       opened: {
        type: Boolean,
        value: false,
        reflectToAttribute: true
      },
      /**
       * false : the dt-picker contents will open in a panel.
       * true : the dt-picker contents will fill the window
       * or an element defined by the `fitIntoElement`.
       */
       fillContainer: {
        type: Boolean,
        value: false,
        reflectToAttribute: true
      },
      /**
       * The element that the dt-picker contents will fully exand into
       * when the dt-picker is open.
       * `fillContainer` must be true inorder for this property to work
       */
      fitIntoElement: {
        type: Object,
        value: window
      },
      /**
       * List of key/values to be included for translating this component
       */
      resources: {
        type: Object,
        value: function() {
          return {
            'en': {
              'Today': 'Today'
            }
          };
        }
      },
      /**
      * set a default for localizing
      */
     language: {
       type: String,
       value: 'en'
     },
     /**
      * Use the key for localization if value for  language is missing. Should
      * always be true for  our components
      */
     useKeyIfMissing: {
       type: Boolean,
       value: true
     },
     _tempMomentChangeOrigin: {
       type: String,
       value: ''
     }
    },
    listeners: {
      'px-datetime-entry-icon-clicked':'_iconClicked',
      'px-datetime-button-clicked': '_buttonClicked'
    },
    observers: [
      '_tempMomentChanged(_tempMomentObj)'
    ],
    /**
     * Key bindings for iron-a11y-keys-behavior
     */
    keyBindings: {
      'esc' : '_onEsc',
      'enter': '_onEnter'
    },

    attached: function() {

      this._isAttached = true;
      this.$.calendar.addEventListener('from-moment-changed', this._calendarMomentChanged.bind(this));
      this.$.timeTemplate.addEventListener('moment-obj-changed', this._calendarTimeMomentChanged.bind(this));
      this.$.field.addEventListener('moment-obj-changed', this._fieldMomentChanged.bind(this));
    },

    /*
     * 'Today' button/text has been clicked
     */
    _todayClicked: function(evt) {
      var today = this._preserveTime(this.momentObj, Px.moment.tz(Px.moment(), this.timeZone));
      this._tempMomentChangeOrigin = 'calendar'
      this.set('_tempMomentObj', newMoment);
    },
    /**
     */
    _onEsc: function(evt) {
      this._close();
    },
    /**
     */
    _onEnter: function(evt) {
      this._validateCalendarMoment();
    },
    /**
     * Opens the calendar
     */
    _open: function() {
      this.$.dropdown.open();
    },
    /**
     * Closes the calendar
     */
    _close: function() {
      this.$.dropdown.close();
    },

    _tempMomentChanged: function(evt, test, t) {

      if(this._tempMomentChangeOrigin === 'field') {

        //field only changes moment when it has been validated, we can trust that change
        this._applyTempMoment();
      } else if (this._tempMomentChangeOrigin === 'calendarTime') {

      } else if(this._tempMomentChangeOrigin === 'calendar') {

        //time changed in calendar. Only process if no button,
        if(!this.showButtons) {

          this._validateCalendarMoment();
        }
      }

      this._tempMomentChangeOrigin = '';
    },

    _calendarMomentChanged : function(evt) {
      this._tempMomentChangeOrigin = 'calendar';
    },

    _calendarTimeMomentChanged : function(evt) {
      this._tempMomentChangeOrigin = 'calendarTime';
    },

    _fieldMomentChanged : function(evt) {
      this._tempMomentChangeOrigin = 'field';
    },

    /**
     */
     _validateCalendarMoment: function(newMoment) {

      if(this.opened) {

        //apply: accept if valid
        if(this.$.field.isValid) {
          this._applyTempMoment();
          this._close();
        } else {
          //don't close, can't apply if not valid
        }
      }
    },
    /**
     */
    _buttonClicked: function(evt) {
      if(evt.detail.action) {

       this._validateCalendarMoment();
      } else {
        this._rollbackTempMoment();
        this._close();
      }
    },

    _internalChangeFieldMoment: function(newMoment) {
      this._internalChange = true;
      this.$.field.set('momentObj', newMoment);
      this._internalChange = false;
    },
    /**
     */
    _iconClicked: function(evt) {
      if(evt.detail.dateOrTime === "Date") {
        this.$.dropdown.toggle();
      }
    },
    /**
     * Determine if field should be displayed in container
     * The dt-field will only appear in the container if fillContainer is true
     */
    _handleField: function(hideTime, fillContainer){
      return (!hideTime && fillContainer);
    },

    // ********************************************************************** //
    // Calculate iron-dropdown properties
    // ********************************************************************** //

    _getVerticalOffset: function(fillContainer) {
      return !fillContainer ? 20 : 0;
    },
    _getPositionTarget: function(fillContainer, fitIntoElement) {
      return fillContainer ? fitIntoElement : this.$.field;
    },
    getElement: function(elStr) {
      return this.shadowRoot.querySelector(elStr)
    }


  });
</script>
